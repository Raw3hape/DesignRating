# Email Collection & Analytics MVP Setup

Этот документ описывает полную реализацию MVP для сбора email адресов и аналитики с использованием Vercel KV.

## Реализованные возможности

### 1. Сбор Email адресов
- ✅ Modal окно для ввода email перед анализом
- ✅ Валидация email адресов (формат, временные домены)
- ✅ Honeypot защита от ботов
- ✅ Rate limiting для предотвращения спама
- ✅ Сохранение пользователей в Vercel KV

### 2. Аналитика и статистика
- ✅ Глобальная статистика (всего пользователей, анализов)
- ✅ Daily статистика (анализы и уникальные пользователи по дням)
- ✅ Сохранение каждого анализа с привязкой к email

### 3. Админ панель
- ✅ Защищенная админ панель с API ключом
- ✅ Просмотр статистики в реальном времени
- ✅ Список последних анализов
- ✅ График активности по дням

### 4. Rate Limiting
- ✅ Разные лимиты для разных endpoint'ов
- ✅ Защита от спама и злоупотреблений

## Структура данных в Vercel KV

```
user:{email}           - Информация о пользователе
analysis:{id}          - Данные конкретного анализа
stats:global           - Глобальная статистика
stats:daily:{date}     - Ежедневная статистика
```

## API Endpoints

### Email Authentication
- `POST /api/auth/email` - Регистрация/авторизация по email

### Analysis
- `POST /api/analyze` - Анализ дизайна (теперь сохраняет данные в KV)

### Admin
- `GET /api/admin/stats?apiKey=xxx` - Получение статистики для админа

## Переменные окружения

Добавьте в `.env.local`:

```bash
# Существующие переменные
OPENAI_API_KEY=your_openai_api_key
STRIPE_SECRET_KEY=your_stripe_secret_key
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key

# Новые переменные для MVP
ADMIN_API_KEY=your_secure_admin_api_key_here

# Vercel KV (автоматически настраивается в Vercel)
KV_REST_API_URL=your_kv_rest_api_url
KV_REST_API_TOKEN=your_kv_rest_api_token
```

## Настройка Vercel KV

1. В Vercel Dashboard перейдите в Storage
2. Создайте новую KV базу данных
3. Подключите её к вашему проекту
4. Переменные `KV_REST_API_URL` и `KV_REST_API_TOKEN` будут добавлены автоматически

## Локальная разработка

Для локальной разработки без KV все данные сохраняются в памяти. Это позволяет тестировать функциональность без настройки Vercel KV.

## Rate Limiting

Настроены следующие лимиты (15 минут):
- `/api/analyze` - 5 запросов
- `/api/auth/email` - 3 запроса
- `/api/admin/*` - 100 запросов
- Остальные API - 10 запросов

## Использование админ панели

1. Перейдите на `/admin`
2. Введите API ключ из переменной `ADMIN_API_KEY`
3. Просматривайте статистику в реальном времени

## Пользовательский flow

1. Пользователь загружает изображения
2. При нажатии "Analyze" показывается modal для ввода email
3. Email валидируется и сохраняется в KV
4. Запускается анализ дизайна
5. Результаты анализа сохраняются с привязкой к email
6. Обновляется статистика

## Безопасность

- Email валидация включает проверку временных доменов
- Honeypot поле для защиты от ботов
- Rate limiting для всех API endpoints
- Админ панель защищена API ключом
- Fallback на memory storage при проблемах с KV

## Масштабирование

Для продакшена рекомендуется:
- Использовать Redis для rate limiting вместо memory storage
- Добавить индексы для быстрого поиска в KV
- Реализовать пагинацию для админ панели
- Добавить мониторинг и алерты

## Компоненты

### Новые компоненты
- `EmailModal` - Modal для ввода email
- `AdminPage` - Страница админ панели

### Обновленные компоненты
- `page.tsx` - Добавлен flow с email modal
- `AnalysisResults` - Остался без изменений

### Новые утилиты
- `lib/kv.ts` - Сервис для работы с Vercel KV
- `types/index.ts` - Дополнительные TypeScript типы

## Тестирование

```bash
# Запуск сервера разработки
npm run dev

# Сборка для продакшена
npm run build

# Запуск в продакшене
npm start
```

Проект готов к деплою на Vercel с полной поддержкой email коллекции и аналитики!